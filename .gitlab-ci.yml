variables:
  MELTANO_IMAGE_NAME: meltano/meltano
  MELTANO_IMAGE_TAG: latest

build:
  stage: build
  image: docker:stable
  variables:
    DOCKER_DRIVER: overlay2
    MELTANO_IMAGE: $MELTANO_IMAGE_NAME:$MELTANO_IMAGE_TAG
  services:
  - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --build-arg MELTANO_IMAGE=$MELTANO_IMAGE .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

.meltano-project:
  image:
    name: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    entrypoint: [""]

  before_script: &before_script
  - cp -r /project/.meltano .
  - cp /project/discovery.yml .

elt:gitlab-to-jsonl:
  extends: .meltano-project
  before_script:
  - *before_script
  - mkdir -p output
  script:
  - meltano elt tap-gitlab target-jsonl --job_id=gitlab-to-jsonl
  - head -n 1 output/tags.jsonl
  artifacts:
    paths:
    - .meltano/run/elt
    - output
    when: always

elt:gitlab-to-postgres:
  extends: .meltano-project
  variables:
    # `postgres` service configuration
    POSTGRES_HOST_AUTH_METHOD: trust
    POSTGRES_ADDRESS: postgres
    POSTGRES_PORT: 5432
    POSTGRES_USER: meltano
    POSTGRES_PASSWORD: ""
    POSTGRES_DB: demo-warehouse

    # `target-postgres` configuration
    PG_ADDRESS: $POSTGRES_ADDRESS
    PG_PORT: $POSTGRES_PORT
    PG_USERNAME: $POSTGRES_USER
    PG_PASSWORD: $POSTGRES_PASSWORD
    PG_DATABASE: $POSTGRES_DB
  services:
  - postgres:11
  before_script:
  - *before_script
  - apt-get update -y
  - apt-get install -y postgresql-client
  script:
  - meltano elt tap-gitlab target-postgres --transform=run --job_id=gitlab-to-postgres
  - >
    PGPASSWORD=$PG_PASSWORD
    psql 
    -U $PG_USERNAME 
    -h $PG_ADDRESS 
    -p $PG_PORT 
    -d $PG_DATABASE 
    -c "SELECT * FROM analytics.gitlab_tags LIMIT 1;"
  artifacts:
    paths:
    - .meltano/run/elt
    when: always

config:tap-covid-19:
  extends: .meltano-project
  script:
  - meltano config tap-covid-19

select:tap-covid-19:
  extends: .meltano-project
  # variables:
    # `tap-covid-19` extractor configuration
    # TAP_COVID_19_API_TOKEN: set through https://gitlab.com/meltano/demo-project/-/settings/ci_cd
  script:
  - meltano select --list tap-covid-19